"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getRelationsWithJoinsTE = void 0;
const shared_1 = require("@ts-safeql/shared");
const assert_1 = __importDefault(require("assert"));
const fp_ts_1 = require("fp-ts");
const function_1 = require("fp-ts/function");
const libpg_query_1 = __importDefault(require("libpg-query"));
const mocha_1 = require("mocha");
const get_relations_with_joins_1 = require("./get-relations-with-joins");
const cases = [
    {
        query: `
      SELECT *
      FROM caregiver
    `,
        expected: [],
    },
    {
        query: `
    SELECT *
    FROM
      caregiver
        LEFT JOIN agency ON caregiver.id = agency.id
    `,
        expected: [["caregiver", [{ name: "agency", type: shared_1.LibPgQueryAST.JoinType.JOIN_LEFT }]]],
    },
    {
        query: `
      SELECT
        caregiver.id as caregiver_id,
        caregiver_agency.id as assoc_id
      FROM caregiver
        LEFT JOIN caregiver_agency ON caregiver.id = caregiver_agency.caregiver_id
        LEFT JOIN agency ON caregiver_agency.agency_id = agency.id
    `,
        expected: [
            [
                "caregiver",
                [
                    { name: "caregiver_agency", type: shared_1.LibPgQueryAST.JoinType.JOIN_LEFT },
                    { name: "agency", type: shared_1.LibPgQueryAST.JoinType.JOIN_LEFT },
                ],
            ],
        ],
    },
    {
        query: `
      SELECT
        a.x
      FROM
        a
          FULL JOIN w ON w.id = a.w_id
          INNER JOIN x ON x.id = a.x_id
          LEFT JOIN y ON y.id = a.y_id
          RIGHT JOIN z ON z.id = a.z_id,
        b
          FULL JOIN w ON w.id = b.w_id
          INNER JOIN x ON x.id = b.x_id
          LEFT JOIN y ON y.id = b.y_id
          RIGHT JOIN z ON z.id = b.z_id,
        c
    `,
        expected: [
            [
                "a",
                [
                    { name: "w", type: shared_1.LibPgQueryAST.JoinType.JOIN_FULL },
                    { name: "x", type: shared_1.LibPgQueryAST.JoinType.JOIN_INNER },
                    { name: "y", type: shared_1.LibPgQueryAST.JoinType.JOIN_LEFT },
                    { name: "z", type: shared_1.LibPgQueryAST.JoinType.JOIN_RIGHT },
                ],
            ],
            [
                "b",
                [
                    { name: "w", type: shared_1.LibPgQueryAST.JoinType.JOIN_FULL },
                    { name: "x", type: shared_1.LibPgQueryAST.JoinType.JOIN_INNER },
                    { name: "y", type: shared_1.LibPgQueryAST.JoinType.JOIN_LEFT },
                    { name: "z", type: shared_1.LibPgQueryAST.JoinType.JOIN_RIGHT },
                ],
            ],
        ],
    },
    {
        query: `
      SELECT subselect.id
      FROM tbl
        LEFT JOIN (SELECT * FROM inner1) AS subselect1 on subselect.id = tbl.id 
        LEFT JOIN (SELECT * FROM inner2) AS subselect2 on subselect2.id = tbl.id 
        LEFT JOIN (SELECT * FROM inner3) AS subselect3 on subselect3.id = tbl.id 
    `,
        expected: [
            [
                "tbl",
                [
                    { name: "subselect1", type: shared_1.LibPgQueryAST.JoinType.JOIN_LEFT },
                    { name: "subselect2", type: shared_1.LibPgQueryAST.JoinType.JOIN_LEFT },
                    { name: "subselect3", type: shared_1.LibPgQueryAST.JoinType.JOIN_LEFT },
                ],
            ],
        ],
    },
];
exports.getRelationsWithJoinsTE = (0, function_1.flow)(libpg_query_1.default.parseQuery, fp_ts_1.taskEither.tryCatchK(function_1.identity, shared_1.InternalError.to), fp_ts_1.taskEither.map(get_relations_with_joins_1.getRelationsWithJoins));
for (const { query, expected, only } of cases) {
    const tester = only ? mocha_1.test.only : mocha_1.test;
    tester(`get relations with joins: ${query}`, async () => {
        return (0, function_1.pipe)((0, exports.getRelationsWithJoinsTE)(query), fp_ts_1.taskEither.match((error) => assert_1.default.fail(error.message), (result) => assert_1.default.deepEqual([...result.entries()], expected)))();
    });
}
//# sourceMappingURL=get-relations-with-joins.test.js.map